name: Run Tests

inputs:
  Build-GOOGLE-SERVICES:
    description: secrets.GOOGLE_SERVICES_JSON
    required: true

runs:
  using: composite
  steps:
    - name: Check out
      uses: actions/checkout@v4
      with:
        lfs: true
        fetch-depth: 0

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: gradle

    - name: Create google-services.json
      shell: bash
      run: |
        echo "${{ inputs.Build-GOOGLE-SERVICES }}" > /home/runner/work/EsmorgaAndroid/EsmorgaAndroid/app/google-services.json

    - name: Grant execute permission for gradlew
      shell: bash
      run: chmod +x gradlew

    - name: Test with Gradle
      id: tests
      shell: bash
      run: ./gradlew view:verifyPaparazzi koverHtmlReport
      continue-on-error: true

    - name: Publish JUnit Report (on failure)
      if: steps.tests.outcome == 'failure'
      uses: mikepenz/action-junit-report@v4
      with:
        report_paths: |
          **/build/test-results/**/*.xml
        check_name: Failed Test Report
        detailed_summary: true
        require_tests: true
        fail_on_failure: false
